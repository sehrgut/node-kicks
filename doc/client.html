<!DOCTYPE html><html lang="en"><head><title>client</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="client"><meta name="groc-project-path" content="lib/client.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/client.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">fmt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">).</span><span class="nx">format</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">version</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./version&#39;</span><span class="p">).</span><span class="nx">version</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">request_options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">encoding</span><span class="o">:</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span>
  <span class="nx">json</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;User-Agent&#39;</span><span class="o">:</span> <span class="nx">fmt</span><span class="p">(</span><span class="s1">&#39;node-kicks/v%s; node.js/%s&#39;</span><span class="p">,</span> <span class="nx">version</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">version</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="_client_"><em>Client</em></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handles all our stuff, but really shouldn't be directly
instantiated unless you know what you're doing (i.e. have a cached OAUTH
token from a previous session, and you know it's good).</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">Client</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>oauth_token</code> <em>string</em>: OAUTH token provided by <code>Client.authenticate</code></p></div></div><div class="code"><div class="wrapper">    <span class="nx">oauth_token</span><span class="p">,</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>options</code> <em>object</em>: options map in the format of <code>Client.defaults</code>
(other options are ignored)</p></div></div><div class="code"><div class="wrapper">    <span class="nx">options</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">oauth_token</span> <span class="o">=</span> <span class="nx">oauth_token</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">merge</span><span class="p">({},</span> <span class="nx">Client</span><span class="p">.</span><span class="nx">defaults</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_endpoints</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="shared-properties">Shared Properties</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientdefaults">Client.defaults</h3>

<p>default parameters for all clients</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">=</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>proxy</code> <em>string</em>: proxy server passed on to the <code>request</code> framework
(TODO: honour proxy setting)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">proxy</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>client_id</code> <em>string</em>: Kickstarter client id/API key. The only known
the only known valid id is this default, derived from the iOS app.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">client_id</span><span class="o">:</span> <span class="s1">&#39;2II5GGBZLOOZAA5XBU1U0Y44BU57Q58L8KOGM7H0E0YFHP3KTG&#39;</span><span class="p">,</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>endpoint</code> <em>string</em>: the URL against which to authenticate and fetch
endpoints. All other operations use fully-specified endpoint URLs
provided by the API itself.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">endpoint</span><span class="o">:</span> <span class="s1">&#39;https://api.kickstarter.com/&#39;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="shared-functions">Shared Functions</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientfromemail">Client.fromEmail</h3>

<p>(factory function) authenticates against Kickstarter's server with the
provided credentials and returns an initialized Client object.</p>

<p>TODO: Eagerly retrieve API endpoints.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">fromEmail</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>email</code> <em>string</em>: Kickstarter account email address</p></div></div><div class="code"><div class="wrapper">    <span class="nx">email</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>password</code> <em>string</em>: Kickstarter account password</p></div></div><div class="code"><div class="wrapper">    <span class="nx">password</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>options</code> <em>object</em>: options map to override <code>Client.defaults</code></p></div></div><div class="code"><div class="wrapper">    <span class="nx">options</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>cb</code> <em>callback (err, object)</em></p></div></div><div class="code"><div class="wrapper">    <span class="nx">cb</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="nx">Client</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;access_token&#39;</span><span class="p">))</span>
        <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">access_token</span><span class="p">,</span> <span class="nx">options</span><span class="p">));</span>
      <span class="k">else</span>
        <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unknown error&#39;</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cb</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientauthenticate">Client.authenticate</h3>

<p>authenticates against Kickstarter's server with the provided credentials
and returns an authentication object.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">authenticate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>email</code> <em>string</em>: Kickstarter account email address</p></div></div><div class="code"><div class="wrapper">    <span class="nx">email</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>password</code> <em>string</em>: Kickstarter account password</p></div></div><div class="code"><div class="wrapper">    <span class="nx">password</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>options</code> <em>object</em>: options map to override <code>Client.defaults</code></p></div></div><div class="code"><div class="wrapper">    <span class="nx">options</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>cb</code> <em>callback (err, string)</em></p></div></div><div class="code"><div class="wrapper">    <span class="nx">cb</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">merge</span><span class="p">({},</span> <span class="nx">Client</span><span class="p">.</span><span class="nx">defaults</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  
  <span class="nx">ropts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">qs</span><span class="o">:</span> <span class="p">{</span> <span class="nx">client_id</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">client_id</span> <span class="p">},</span>
    <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">,</span> <span class="s1">&#39;xauth/access_token&#39;</span><span class="p">),</span>
    <span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="nx">email</span><span class="o">:</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span> <span class="p">}</span>
  <span class="p">};</span>
  
  <span class="nx">request</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">merge</span><span class="p">({},</span> <span class="nx">request_options</span><span class="p">,</span> <span class="nx">ropts</span><span class="p">),</span> <span class="kd">function</span> <span class="nx">onPost</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="s1">&#39;error_messages&#39;</span><span class="p">))</span>
      <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">error_messages</span><span class="p">));</span>
    <span class="k">else</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">body</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="instance-methods">Instance Methods</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientapi-call">Client#api_call</h3>

<p>handles all session-based API calls (read: everything but auth). It takes
care of things like passing API errors as exceptions through the callback
chain and wrapping child API urls up as nice and pretty node functions.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">api_call</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>api_url</code> <em>string</em>: fully-specified absolute URL, such as those
provided by the Kickstarter API in <code>data.urls.api</code> collections
of API responses.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">api_url</span><span class="p">,</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>qs</code> <em>object</em>: map of query string keys and values to be passed
(TODO: Make this optional by checking <code>_.isFunction</code>)</p></div></div><div class="code"><div class="wrapper">    <span class="nx">qs</span><span class="p">,</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>cb</code> <em>callback (err, data)</em>: callback to receive API response</p></div></div><div class="code"><div class="wrapper">    <span class="nx">cb</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">qs</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">cb</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">;</span>
    <span class="nx">qs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">ropts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">url</span><span class="o">:</span> <span class="nx">api_url</span><span class="p">,</span>
    <span class="nx">qs</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">merge</span><span class="p">({</span> <span class="nx">oauth_token</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">oauth_token</span> <span class="p">},</span> <span class="nx">qs</span><span class="p">)</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">process_api_call</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;error_messages&#39;</span><span class="p">))</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: detect bad auth, and try re-auth()ing our client</p></div></div><div class="code"><div class="wrapper">      <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">error_messages</span><span class="p">.</span><span class="nx">toString</span><span class="p">()));</span>
    <span class="k">else</span>
      <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">entify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">merge</span><span class="p">({},</span> <span class="nx">request_options</span><span class="p">,</span> <span class="nx">ropts</span><span class="p">),</span> <span class="nx">process_api_call</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientwrap">Client#wrap</h3>

<p>takes an API URL and returns a function which calls <code>Client#api_call</code>
for it.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">wrap</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>api_url</code> <em>string</em>: API URL which could be passed to <code>Client#api_call</code></p></div></div><div class="code"><div class="wrapper">    <span class="nx">api_url</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">api_call</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">api_url</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="cliententify">Client#entify</h3>

<p>recursively searches the <code>data</code> object for <code>_object_.urls.api</code> collections
and creates parallel collections of API call functions at <code>_object_.api</code>.</p>

<p>TODO: Currently only recurses down properties with <code>Array</code> values. Can we
identify objects which are collections of API objects, and search them as
well?</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">entify</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  
  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;api&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">k</span> <span class="o">==</span> <span class="s1">&#39;urls&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="s1">&#39;api&#39;</span><span class="p">))</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">api</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">api</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">api_url</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">api</span><span class="p">[</span><span class="nx">proc</span><span class="p">]</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">api_url</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">api</span><span class="p">;</span>
      <span class="p">},</span> <span class="p">{});</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">entify</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">that</span><span class="p">));</span>
  <span class="p">});</span>
  
  <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientunpaginate-projects">Client#unpaginate_projects</h3>

<p>wraps API calls which return collections of projects to retrieve multiple
pages of results at once. It is a higher-order function which returns a
function of the signature <code>function (n, cb)</code>, where <code>n</code> is the number of
projects to attempt to retrieve. Retrieval is stopped when the last page of
results is retrieved, or the number of projects retrieved equals or exceeds
the requested number.</p>

<p>TODO: Return a <code>next()</code> pointer to the callback to allow resumption of
the search.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">unpaginage_projects</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>proc</code> <em>mixed</em>: API URL or function which returns a Kickstarter API
response to its callback</p></div></div><div class="code"><div class="wrapper">    <span class="nx">proc</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">proc</span><span class="p">))</span>
    <span class="nx">proc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">proc</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">unpaginated</span> <span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">[];</span>
    
    <span class="kd">function</span> <span class="nx">read_projects</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">projects</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">out</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">api</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">more_projects</span><span class="p">)</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">more_projects</span><span class="p">(</span><span class="nx">read_projects</span><span class="p">);</span>
        <span class="k">else</span>
          <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">out</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">proc</span><span class="p">(</span><span class="nx">read_projects</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientendpoint">Client#endpoint</h3>

<p>returns an API endpoint function for the requested name, if one exists
at the root level of the Kickstarter API</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">endpoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>proc</code> <em>string</em>: one of <em>categories</em>, <em>popular</em>projects<em>,
_ending</em>soon<em>projects</em>, <em>near</em>projects<em>, _search</em>projects<em>, or _self</em>;
or any other named API function which may be added, and returned by
<code>Client#endpoints</code></p></div></div><div class="code"><div class="wrapper">    <span class="nx">proc</span><span class="p">,</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>cb</code> <em>callback (err, fn)</em>: callback to receive endpoint function</p></div></div><div class="code"><div class="wrapper">    <span class="nx">cb</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">endpoints</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">proc</span><span class="p">))</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">proc</span><span class="p">]);</span>
    <span class="k">else</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">fmt</span><span class="p">(</span><span class="s1">&#39;Unknown remote procedure &quot;%s&quot;&#39;</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)));</span>
  <span class="p">});</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientendpoints">Client#endpoints</h3>

<p>lazily loads and returns a map of named API endpoints from Kickstarter</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">endpoints</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>cb</code> <em>callback (err, object)</em>: callback to receive map of API endpoints</p></div></div><div class="code"><div class="wrapper">    <span class="nx">cb</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">save_endpoint_urls</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">entify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_endpoints</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">api</span><span class="p">;</span>
      <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_endpoints</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_endpoints</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_endpoints</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">api_call</span><span class="p">(</span>
      <span class="nx">url</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">,</span> <span class="s1">&#39;v1/&#39;</span><span class="p">),</span>
      <span class="kc">null</span><span class="p">,</span>
      <span class="nx">save_endpoint_urls</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientexec">Client#exec</h3>

<p><strong>deprecated</strong></p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">exec</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">proc</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">(</span><span class="nx">proc</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">api_url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">api_call</span><span class="p">(</span><span class="nx">api_url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="convenience-methods-for-known-endpoints">Convenience methods for known endpoints</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientcategories">Client#categories</h3>

<p>retrieves the list of project categories from Kickstarter and returns them
as an array of category objects.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">categories</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>cb</code> <em>callback (err, array)</em></p></div></div><div class="code"><div class="wrapper">    <span class="nx">cb</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">proc</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="s1">&#39;categories&#39;</span><span class="p">))</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">categories</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;No categories found&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientending-soon-projects">Client#ending_soon_projects</h3>

<p>retrieves an unpaginated list of projects and returns them as an array of
project objects.</p>

<p>TODO: See if the underlying API accepts "category_id" or similar parameter.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ending_soon_projects</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>n</code> <em>integer</em>: target number of entries to retrieve</p></div></div><div class="code"><div class="wrapper">    <span class="nx">n</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>cb</code> <em>callback (err, array)</em></p></div></div><div class="code"><div class="wrapper">    <span class="nx">cb</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">(</span><span class="s1">&#39;ending_soon_projects&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">that</span><span class="p">.</span><span class="nx">unpaginage_projects</span><span class="p">(</span><span class="nx">proc</span><span class="p">)(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientnear-projects">Client#near_projects</h3>

<p>retrieves an unpaginated list of projects near a location and returns them
as an array of project objects.</p>

<p>TODO: this can take an "ll" parameter, which seems to be unrelated
to either location.location_id or location.name.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">near_projects</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>location_id</code> <em>integer</em>: a Kickstarter internal identifier, which
must be gleaned from examining the <code>location.location_id</code> property of
a project or user object.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">location_id</span><span class="p">,</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>n</code> <em>integer</em>: target number of entries to retrieve</p></div></div><div class="code"><div class="wrapper">    <span class="nx">n</span><span class="p">,</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>cb</code> <em>callback (err, array)</em></p></div></div><div class="code"><div class="wrapper">    <span class="nx">cb</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">qs</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">location_id</span><span class="o">:</span> <span class="nx">location_id</span> <span class="p">};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">(</span><span class="s1">&#39;near_projects&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">that</span><span class="p">.</span><span class="nx">unpaginage_projects</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">qs</span><span class="p">))(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientpopular-projects">Client#popular_projects</h3>

<p>retrieves an unpaginated list of popular projects and returns them as an
array of project objects.</p>

<p>TODO: Can this method accept category or location parameters?</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">popular_projects</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>n</code> <em>integer</em>: target number of entries to retrieve</p></div></div><div class="code"><div class="wrapper">    <span class="nx">n</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>cb</code> <em>callback (err, array)</em></p></div></div><div class="code"><div class="wrapper">    <span class="nx">cb</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">(</span><span class="s1">&#39;popular_projects&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">that</span><span class="p">.</span><span class="nx">unpaginage_projects</span><span class="p">(</span><span class="nx">proc</span><span class="p">)(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientsearch-projects">Client#search_projects</h3>

<p>retrieves an unpaginated list of projects matching the query and returns them
as an array of project objects.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">search_projects</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>query</code> <em>string</em>: query against which to match projects</p></div></div><div class="code"><div class="wrapper">    <span class="nx">query</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>n</code> <em>integer</em>: target number of entries to retrieve</p></div></div><div class="code"><div class="wrapper">    <span class="nx">n</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>cb</code> <em>callback (err, array)</em></p></div></div><div class="code"><div class="wrapper">    <span class="nx">cb</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">qs</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">q</span><span class="o">:</span> <span class="nx">query</span> <span class="p">};</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">(</span><span class="s1">&#39;search_projects&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">that</span><span class="p">.</span><span class="nx">unpaginage_projects</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">qs</span><span class="p">))(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clientself">Client#self</h3>

<p>retrieves the user object corresponding to the authenticated user.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">self</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="parameters">Parameters</h4>

<p><code>cb</code> <em>callback (err, object)</em></p></div></div><div class="code"><div class="wrapper">    <span class="nx">cb</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">proc</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">Client</span><span class="o">:</span> <span class="nx">Client</span>
<span class="p">};</span> </div></div></div></div></body></html>